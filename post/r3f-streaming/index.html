<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="前言 上个月从零开始直接上手react three fiber，跟着同事写了一堆交互，总算弄得差不多了。不会React，不会TS，不会three，真不知道"><title>R3F蒙版&绿幕推流</title><link rel=canonical href=/post/r3f-streaming/><link rel=stylesheet href=/scss/style.min.d4a80d4a57f2f4dc19b368dd2866a2ebdd05c3e09c32e46302d42fdf0264eca0.css><script src=https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js></script>
<script src=https://cdn.staticfile.net/jquery.imagesloaded/5.0.0/imagesloaded.pkgd.min.js crossorigin=anonymous></script><meta property="og:title" content="R3F蒙版&绿幕推流"><meta property="og:description" content="前言 上个月从零开始直接上手react three fiber，跟着同事写了一堆交互，总算弄得差不多了。不会React，不会TS，不会three，真不知道"><meta property="og:url" content="/post/r3f-streaming/"><meta property="og:site_name" content="Shirakii"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="web"><meta property="article:tag" content="r3f"><meta property="article:published_time" content="2023-09-14T17:18:38+08:00"><meta property="article:modified_time" content="2023-09-23T22:08:37+08:00"><meta property="og:image" content="/post/r3f-streaming/cover.jpg"><meta name=twitter:title content="R3F蒙版&绿幕推流"><meta name=twitter:description content="前言 上个月从零开始直接上手react three fiber，跟着同事写了一堆交互，总算弄得差不多了。不会React，不会TS，不会three，真不知道"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/post/r3f-streaming/cover.jpg"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"dark")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><div id=article-toolbar style=position:sticky;top:5px;z-index:0><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>返回</span></a></div><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#前言>前言</a></li><li><a href=#前期准备>前期准备</a></li><li><a href=#视频流>视频流</a></li><li><a href=#obs虚拟摄像头>OBS虚拟摄像头</a></li><li><a href=#绿幕shader>绿幕shader</a></li><li><a href=#后话>后话</a></li><li><a href=#参考链接>参考链接</a></li><li><a href=#byebye>Bye~Bye</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/post/r3f-streaming/><img src=/post/r3f-streaming/cover.jpg width=1239 height=1236 loading=lazy alt="Featured image of post R3F蒙版&绿幕推流"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/post/r3f-streaming/>R3F蒙版&绿幕推流</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>2023-09-14</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 3 分钟</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-file-description" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 001 1h4"/><path d="M17 21H7a2 2 0 01-2-2V5a2 2 0 012-2h7l5 5v11a2 2 0 01-2 2z"/><path d="M9 17h6"/><path d="M9 13h6"/></svg><time class=article-words>1228字</time></div></footer></div></header><section class=article-content><h2 id=前言>前言</h2><p>上个月从零开始直接上手<code>react three fiber</code>，跟着同事写了一堆交互，总算弄得差不多了。不会<code>React</code>，不会<code>TS</code>，不会<code>three</code>，真不知道自己怎么过来的。途中也了解到原子化<code>css</code>，总之收获颇丰。目前是因为需要将渲染画面推流到场景中，故做点经验分享</p><h2 id=前期准备>前期准备</h2><p>首先得创建个场景然后播放视频吧，可以参考下面我做的这个案例</p><figure><img loading=lazy src=https://uploads.codesandbox.io/uploads/user/831db286-7f88-4d2e-804a-05751a1066ca/lUPY-thumbnail.jpg width=80%><figcaption><p><a href=https://codesandbox.io/s/green-screen-streaming-js2vkw><strong>GreenScreen-Streaming</strong></a></p></figcaption></figure><p>首先做一个<code>VideoMaterial</code>的function，减少耦合度。当然你也可以写的简单点，这里主要是为了后续添加遮罩的方便。但是存在一定色差，暂时没找到解决方法</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=kd>function</span> <span class=nx>VideoMaterial</span><span class=p>({</span> <span class=nx>src</span><span class=p>,</span> <span class=nx>mask_src</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>texture</span> <span class=o>=</span> <span class=nx>src</span> <span class=o>?</span> <span class=nx>useVideoTexture</span><span class=p>(</span><span class=nx>src</span><span class=p>)</span> <span class=o>:</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mask</span> <span class=o>=</span> <span class=nx>mask_src</span> <span class=o>?</span> <span class=nx>useVideoTexture</span><span class=p>(</span><span class=nx>mask_src</span><span class=p>)</span> <span class=o>:</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meshPhysicalMaterial</span>
</span></span><span class=line><span class=cl>      <span class=na>color</span><span class=o>=</span><span class=p>{</span><span class=mh>0x000000</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=na>emissive</span><span class=o>=</span><span class=p>{</span><span class=mh>0xffffff</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=na>emissiveMap</span><span class=o>=</span><span class=p>{</span><span class=nx>texture</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=na>alphaMap</span><span class=o>=</span><span class=p>{</span><span class=nx>mask</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=na>emissiveIntensity</span><span class=o>=</span><span class=p>{</span><span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=na>opacity</span><span class=o>=</span><span class=p>{</span><span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=na>transparent</span><span class=o>=</span><span class=p>{</span><span class=kc>true</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=na>toneMapped</span><span class=o>=</span><span class=p>{</span><span class=kc>false</span><span class=p>}</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>记得用<code>Suspense</code>包裹一下，不然会报错,因为渲染的前后关系不对。建议<code>fallback</code>里给个材质留给加载的时间，这里我放了个<a class=link href=https://www.vecteezy.com/video/4844745-icon-loading-10-circle-gradient-angle-loop-out-black-background-gradient-animation-for-game-animation-video-and-others target=_blank rel=noopener>loading</a>的动画</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>mesh</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>planeGeometry</span> <span class=na>args</span><span class=o>=</span><span class=p>{[</span><span class=mf>7.111</span><span class=p>,</span> <span class=mi>4</span><span class=p>]}</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>Suspense</span> <span class=na>fallback</span><span class=o>=</span><span class=p>{&lt;</span><span class=nt>VideoMaterial</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;loading.mp4&#34;</span> <span class=p>/&gt;}&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>Suspense</span> <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>VideoMaterial</span>
</span></span><span class=line><span class=cl>            <span class=na>src</span><span class=o>=</span><span class=s>&#34;WING IT! - Blender Open Movie.mp4&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>mask_src</span><span class=o>=</span><span class=s>&#39;mask.mp4&#39;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>Suspense</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>mesh</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>这样就可以看到一个带透明通道的视频显示在屏幕上，当然可能用quicktime格式会更快些，但体积大</p><h2 id=视频流>视频流</h2><p>有条件的可以现在主机上插个摄像头，先通过API获取到视频流</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>[</span><span class=nx>stream</span><span class=p>,</span> <span class=nx>setStream</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useState</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>useEffect</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>constraints</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>audio</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>video</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>navigator</span><span class=p>.</span><span class=nx>mediaDevices</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>getUserMedia</span><span class=p>(</span><span class=nx>constraints</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>stream</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>window</span><span class=p>.</span><span class=nx>stream</span> <span class=o>=</span> <span class=nx>stream</span>
</span></span><span class=line><span class=cl>        <span class=nx>setStream</span><span class=p>(</span><span class=nx>stream</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>stream</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>navigator</span><span class=p>.</span><span class=nx>mediaDevices</span><span class=p>.</span><span class=nx>enumerateDevices</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>devices</span><span class=p>)</span> <span class=p>{</span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>devices</span><span class=p>)})</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=k>catch</span><span class=p>((</span><span class=nx>error</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=p>[])</span>
</span></span></code></pre></div><p>不出意外的话屏幕上就能出现摄像头的画面了。另外可以在<code>useState</code>中设置参数来显示加载动画</p><figure><img loading=lazy src=images/1.png#center width=500px></figure><h2 id=obs虚拟摄像头>OBS虚拟摄像头</h2><p>但是我们如果想输出各种画面一般都是使用<a class=link href=https://obsproject.com target=_blank rel=noopener>OBS</a>的虚拟摄像机推流。那么怎么切换摄像机呢？</p><p>可以看到上述的代码通过使用<code>constraints</code>来约束使用的摄像头，需要的<code>deviceId</code>可从<code>console</code>中获取</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>InputDeviceInfo
</span></span><span class=line><span class=cl>deviceId: &#34;6bd3a42e2bf68c2246a5a9bcffa2e43fab316554f504a6ad5687c5674ea6e5d1&#34;
</span></span><span class=line><span class=cl>groupId: &#34;e8291660abbb766dfaaebafbd6f4d3eb046f00603e3cb4d3c2bcd30673415982&#34;
</span></span><span class=line><span class=cl>kind: &#34;videoinput&#34;
</span></span><span class=line><span class=cl>label: &#34;OBS Virtual Camera&#34;
</span></span></code></pre></div><p>于是我们找到OBS虚拟摄像头的信息,填入<code>constraints</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>constraints</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>audio</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>video</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>deviceId</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>YOUR</span> <span class=na>OBS</span> <span class=na>ID</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><h2 id=绿幕shader>绿幕shader</h2><p>接下来就剩抠绿幕了。你或许会问为什么不在OBS里直接用色度键去除呢？因为它不支持推流视频带alpha通道，虽然抠的只剩个人但推出去还是个大黑框</p><p>于是我们就得用到<code>shaderMaterial</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-glsl data-lang=glsl><span class=line><span class=cl><span class=k>const</span> <span class=n>vertexShader</span> <span class=o>=</span> <span class=err>`</span>
</span></span><span class=line><span class=cl>        <span class=k>varying</span> <span class=k>vec2</span> <span class=n>vUv</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>void</span> <span class=n>main</span><span class=p>(</span> <span class=k>void</span> <span class=p>)</span> <span class=p>{</span>     
</span></span><span class=line><span class=cl>            <span class=n>vUv</span> <span class=o>=</span> <span class=n>uv</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>gl_Position</span> <span class=o>=</span> <span class=n>projectionMatrix</span> <span class=o>*</span> <span class=n>modelViewMatrix</span> <span class=o>*</span> <span class=k>vec4</span><span class=p>(</span><span class=n>position</span><span class=p>,</span><span class=mf>1.0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=err>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>export</span> <span class=k>default</span> <span class=n>vertexShader</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>fragmentShader</span> <span class=o>=</span> <span class=err>`</span>
</span></span><span class=line><span class=cl><span class=k>uniform</span> <span class=k>vec3</span> <span class=n>keyColor</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>uniform</span> <span class=k>float</span> <span class=n>similarity</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>uniform</span> <span class=k>float</span> <span class=n>smoothness</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>varying</span> <span class=k>vec2</span> <span class=n>vUv</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>uniform</span> <span class=k>sampler2D</span> <span class=n>map</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>void</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>vec4</span> <span class=n>videoColor</span> <span class=o>=</span> <span class=n>texture2D</span><span class=p>(</span><span class=n>map</span><span class=p>,</span> <span class=n>vUv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>float</span> <span class=n>Y1</span> <span class=o>=</span> <span class=mf>0.299</span> <span class=o>*</span> <span class=n>keyColor</span><span class=p>.</span><span class=n>r</span> <span class=o>+</span> <span class=mf>0.587</span> <span class=o>*</span> <span class=n>keyColor</span><span class=p>.</span><span class=n>g</span> <span class=o>+</span> <span class=mf>0.114</span> <span class=o>*</span> <span class=n>keyColor</span><span class=p>.</span><span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>float</span> <span class=n>Cr1</span> <span class=o>=</span> <span class=n>keyColor</span><span class=p>.</span><span class=n>r</span> <span class=o>-</span> <span class=n>Y1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>float</span> <span class=n>Cb1</span> <span class=o>=</span> <span class=n>keyColor</span><span class=p>.</span><span class=n>b</span> <span class=o>-</span> <span class=n>Y1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>float</span> <span class=n>Y2</span> <span class=o>=</span> <span class=mf>0.299</span> <span class=o>*</span> <span class=n>videoColor</span><span class=p>.</span><span class=n>r</span> <span class=o>+</span> <span class=mf>0.587</span> <span class=o>*</span> <span class=n>videoColor</span><span class=p>.</span><span class=n>g</span> <span class=o>+</span> <span class=mf>0.114</span> <span class=o>*</span> <span class=n>videoColor</span><span class=p>.</span><span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>float</span> <span class=n>Cr2</span> <span class=o>=</span> <span class=n>videoColor</span><span class=p>.</span><span class=n>r</span> <span class=o>-</span> <span class=n>Y2</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>    <span class=k>float</span> <span class=n>Cb2</span> <span class=o>=</span> <span class=n>videoColor</span><span class=p>.</span><span class=n>b</span> <span class=o>-</span> <span class=n>Y2</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>float</span> <span class=n>blend</span> <span class=o>=</span> <span class=n>smoothstep</span><span class=p>(</span><span class=n>similarity</span><span class=p>,</span> <span class=n>similarity</span> <span class=o>+</span> <span class=n>smoothness</span><span class=p>,</span> <span class=n>distance</span><span class=p>(</span><span class=k>vec2</span><span class=p>(</span><span class=n>Cr2</span><span class=p>,</span> <span class=n>Cb2</span><span class=p>),</span> <span class=k>vec2</span><span class=p>(</span><span class=n>Cr1</span><span class=p>,</span> <span class=n>Cb1</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>    <span class=n>gl_FragColor</span> <span class=o>=</span> <span class=k>vec4</span><span class=p>(</span><span class=n>videoColor</span><span class=p>.</span><span class=n>rgb</span><span class=p>,</span> <span class=n>videoColor</span><span class=p>.</span><span class=n>a</span> <span class=o>*</span> <span class=n>blend</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>export</span> <span class=k>default</span> <span class=n>fragmentShader</span>
</span></span></code></pre></div><p><code>App.js</code>内</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>streamTexture</span> <span class=o>=</span> <span class=nx>useVideoTexture</span><span class=p>(</span><span class=nx>stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>material</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>THREE</span><span class=p>.</span><span class=nx>ShaderMaterial</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>transparent</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>uniforms</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>map</span><span class=o>:</span> <span class=p>{</span> <span class=nx>value</span><span class=o>:</span> <span class=nx>streamTexture</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>keyColor</span><span class=o>:</span> <span class=p>{</span> <span class=nx>value</span><span class=o>:</span> <span class=p>[</span><span class=mf>0.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>]</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>similarity</span><span class=o>:</span> <span class=p>{</span> <span class=nx>value</span><span class=o>:</span> <span class=mf>0.7</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>smoothness</span><span class=o>:</span> <span class=p>{</span> <span class=nx>value</span><span class=o>:</span> <span class=mf>0.0</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>vertexShader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>fragmentShader</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Suspense</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>mesh</span>
</span></span><span class=line><span class=cl>        <span class=na>position</span><span class=o>=</span><span class=p>{[</span><span class=o>-</span><span class=mi>8</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=o>-</span><span class=mi>4</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>        <span class=na>scale</span><span class=o>=</span><span class=p>{</span><span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=na>material</span><span class=o>=</span><span class=p>{</span><span class=nx>material</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>planeGeometry</span> <span class=na>args</span><span class=o>=</span><span class=p>{[</span><span class=mf>7.111</span><span class=p>,</span> <span class=mi>4</span><span class=p>]}</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>mesh</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Suspense</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span></code></pre></div><p>这里我事先放了一个绿幕视频作为加载动画，只要输入自己的<code>deviceId</code>就能正常显示了</p><figure><img loading=lazy src=images/alice.gif#center width=500px></figure><h2 id=后话>后话</h2><p>至于为什么这里不采用<code>VideoMaterial</code>另开一个材质函数的写法，而是<code>three.js</code>的用法，是因为我也不知道为什么会有bug，欢迎在评论区交流</p><p>最后在实际体验过程中，我需要让这块平面始终朝向摄像机，会的人可能觉得一个<code>useRef</code>和<code>useFrame</code>就解决了，但是我拿不到父组件的摄像头信息。后来终于发现可以用<code>useThree</code>这个hook，直接拿到<code>camera</code></p><h2 id=参考链接>参考链接</h2><p><a href=https://codesandbox.io/s/2cemck rel=nofollow><img width=20% src=https://camo.githubusercontent.com/911cd7576d9b11ce2cd235f4513198e18fd29b4653545092ff3ebb8017cfdb4a/68747470733a2f2f636f646573616e64626f782e696f2f6170692f76312f73616e64626f7865732f3263656d636b2f73637265656e73686f742e706e673f7632 alt=Demo data-canonical-src=https://codesandbox.io/api/v1/sandboxes/2cemck/screenshot.png?v2 style=max-width:100%></a></p><p><a class=link href=https://sbcode.net/threejs/webcam/ target=_blank rel=noopener>webcam</a></p><div class=video-wrapper><iframe loading=lazy src=https://www.youtube.com/embed/T9F1Wk8DQdg allowfullscreen title="YouTube Video"></iframe></div><h2 id=byebye>Bye~Bye</h2><figure><img loading=lazy src=images/2.jpg width=400><figcaption><p><a href=https://twitter.com/Kerno_kr/status/1697538936015618120>和纱太好看了<br>@Kerno_kr</a></p></figcaption></figure></section><footer class=article-footer><section class=article-tags><a href=/tags/web/>web</a>
<a href=/tags/r3f/>r3f</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>最后更新于 2023-09-23 22:08 CST</span></section></footer></article><script src=//unpkg.com/@waline/client@v2/dist/waline.js></script>
<link href=//unpkg.com/@waline/client@v2/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://unpkg.com/@waline/emojis@1.0.1/weibo"],locale:{admin:"Admin",placeholder:null},requiredMeta:["nick","mail"],serverURL:"https://blog-comments-njvj2fpyz-siya-33.vercel.app/"})</script><footer class=site-footer><section class=copyright>&copy;
2023 -
2024 Shirakii
· <a id=days>0</a> 天</br><script type=text/javascript src=https://storage.ko-fi.com/cdn/widget/Widget_2.js></script><script type=text/javascript>kofiwidget2.init("Support Me on Ko-fi","#353966","Z8Z0HAEDX"),kofiwidget2.draw()</script></section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.18.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section><img src="https://count.getloli.com/get/@:shirakii?theme=asoul" alt=:shirakii>
<script>var s1="2023-08-13",days,number_of_days,s1=new Date(s1.replace(/-/g,"/"));s2=new Date,days=s2.getTime()-s1.getTime(),number_of_days=parseInt(days/(1e3*60*60*24)),document.getElementById("days").innerHTML=number_of_days</script></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".article-page .main-article .article-content img"));images.forEach(e=>{mediumZoom(e,{margin:20,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.8)"})})</script><script type=module src=https://cdn.staticfile.net/ionicons/7.2.1/esm/ionicons.min.js></script><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script></script>-->
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.css></link>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css></link>
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/Siya-33/static@latest/fonts/css/font.css></link>
<script src=https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/nprogress.min.js integrity=sha384-bHDlAEUFxsRI7JfULv3DTpL2IXbbgn4JHQJibgo5iiXSK6Iu8muwqHANhun74Cqg crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/css/nprogress.css integrity=sha384-KJyhr2syt5+4M9Pz5dipCvTrtvOmLk/olWVdfhAp858UCa64Ia5GFpTN7+G4BWpE crossorigin=anonymous><script>NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>